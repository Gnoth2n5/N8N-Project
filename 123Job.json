{
  "name": "123Job",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1456,
        320
      ],
      "id": "55a729f3-f5a5-4c77-a88c-cc885bddb995",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM",
          "mode": "list",
          "cachedResultName": "123Job",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1293046103,
          "mode": "list",
          "cachedResultName": "danh sÃ¡ch cÃ´ng viá»‡c Ä‘Ã£ crawl",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit#gid=1293046103"
        },
        "keepFirstRow": true
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1200,
        -32
      ],
      "id": "a91275d1-9e25-45a4-b9ab-3bf9f0a936f7",
      "name": "XÃ³a danh sÃ¡ch cÃ´ng viá»‡c Ä‘Ã£ crawl",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM",
          "mode": "list",
          "cachedResultName": "123Job",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "list url cáº§n crawl",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1200,
        320
      ],
      "id": "3f979e29-b2fe-454a-9cb4-2eed489fbcf7",
      "name": "Láº¥y Ä‘á»¯ liá»‡u sheet list url cáº§n crawl",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "runCustomScript",
        "scriptCode": "// --- Helper ---\nconst sleep = (ms) => new Promise((res) => setTimeout(res, ms));\n\n// --- Láº¤Y LINK Äáº¦U VÃ€O ---\nlet baseUrl = $json.Url?.trim();\nif (!baseUrl) throw new Error(\"âŒ Thiáº¿u 'Url' trong input!\");\n\nlet major = $json.Major || $json.major || \"\";\n\n// ğŸŸ© GIá»šI Háº N Äá»‚ TRÃNH CRAWL QUÃ NHIá»€U\nconst MAX_PAGES = parseInt($json.MaxPages || $json.maxPages || \"5\"); // Máº·c Ä‘á»‹nh 5 trang\nconst MAX_JOBS = parseInt($json.MaxJobs || $json.maxJobs || \"10\"); // Máº·c Ä‘á»‹nh 10 job\n\nlet allJobs = [];\nlet currentPage = 1;\n\n// ğŸŸ© Tá»‘i Æ°u: Cháº·n request khÃ´ng cáº§n thiáº¿t Ä‘á»ƒ tÄƒng tá»‘c\nawait $page.setRequestInterception(true);\n$page.on(\"request\", (req) => {\n  const t = req.resourceType();\n  const u = req.url();\n  if (\n    [\"image\", \"font\", \"media\"].includes(t) ||\n    /doubleclick|googletagmanager|analytics|facebook|adsystem|adservice|hotjar|mixpanel/i.test(u)\n  ) return req.abort();\n  req.continue();\n});\n\nwhile (true) {\n  // --- Táº O LINK PHÃ‚N TRANG ---\n  let Url = baseUrl;\n  if (currentPage > 1) {\n    Url = baseUrl.includes(\"?\")\n      ? `${baseUrl}&page=${currentPage}`\n      : `${baseUrl}?page=${currentPage}`;\n  }\n\n  console.log(`ğŸŸ¦ Äang xá»­ lÃ½ trang ${currentPage}: ${Url}`);\n\n  // --- ÄI Äáº¾N TRANG ---\n  await $page.goto(Url, { waitUntil: \"domcontentloaded\", timeout: 30000 });\n\n  // --- Äá»¢I JOB HIá»†N RA (123job.vn selectors) ---\n  try {\n    await $page.waitForSelector(\".job_list-item, .job-item, .job-list-item, .job-card, [class*='job'], a[href*='/job/'], a[href*='/viec-lam']\", { timeout: 15000 });\n  } catch {\n    console.log(`âš ï¸ KhÃ´ng tháº¥y job á»Ÿ trang ${currentPage}, dá»«ng láº¡i.`);\n    break;\n  }\n\n  // --- CUá»˜N Äá»‚ LOAD Háº¾T JOB (Tá»I Æ¯U) ---\n  let lastCount = 0;\n  let noChangeCount = 0;\n  for (let i = 0; i < 10; i++) {\n    await $page.evaluate(() => window.scrollBy(0, document.body.scrollHeight));\n    await sleep(500);\n    const currentCount = await $page.$$eval(\n      \".job_list-item, .job-item, .job-list-item, .job-card, [class*='job'], a[href*='/job/'], a[href*='/viec-lam']\",\n      (els) => els.length\n    );\n    if (currentCount === lastCount) {\n      noChangeCount++;\n      if (noChangeCount >= 2) break;\n    } else {\n      noChangeCount = 0;\n    }\n    lastCount = currentCount;\n  }\n\n  // --- Láº¤Y Dá»® LIá»†U (123job.vn) ---\n  const jobsOnPage = await $page.evaluate(() => {\n    // Thá»­ nhiá»u selector phá»• biáº¿n cho 123job.vn\n    const selectors = [\n      \".job-item a[href*='/job/'], .job-item a[href*='/viec-lam']\",\n      \".job-list-item a[href*='/job/'], .job-list-item a[href*='/viec-lam']\",\n      \".job-card a[href*='/job/'], .job-card a[href*='/viec-lam']\",\n      \"a[href*='/job/']:not([href*='#'])\",\n      \"a[href*='/viec-lam']:not([href*='#'])\",\n      \"h2 a[href*='/job/'], h3 a[href*='/job/']\",\n      \".title a[href*='/job/'], .job-title a[href*='/job/']\"\n    ];\n    \n    let jobItems = [];\n    for (const sel of selectors) {\n      const items = document.querySelectorAll(sel);\n      if (items.length > 0) {\n        jobItems = Array.from(items);\n        break;\n      }\n    }\n    \n    // Náº¿u khÃ´ng tÃ¬m tháº¥y, thá»­ tÃ¬m táº¥t cáº£ link cÃ³ chá»©a /job/ hoáº·c /viec-lam/\n    if (jobItems.length === 0) {\n      const allLinks = document.querySelectorAll(\"a[href]\");\n      jobItems = Array.from(allLinks).filter(link => {\n        const href = link.href || \"\";\n        return (href.includes(\"/job/\") || href.includes(\"/viec-lam/\")) && !href.includes(\"#\");\n      });\n    }\n    \n    // Loáº¡i bá» duplicate vÃ  láº¥y thÃ´ng tin (kÃ¨m lÆ°Æ¡ng) - Dá»±a trÃªn HTML structure thá»±c táº¿\n    const uniqueJobs = new Map();\n    jobItems.forEach((item) => {\n      const link = item.href || item.getAttribute(\"href\") || \"\";\n      if (!link || link.includes(\"#\")) return;\n      \n      let fullUrl = link;\n      if (link.startsWith(\"/\")) {\n        fullUrl = \"https://123job.vn\" + link;\n      }\n      \n      const title = item.textContent?.trim() || item.querySelector(\"h2, h3, .title, .job-title, .job_list-item-title\")?.textContent?.trim() || \"\";\n      \n      // TÃ¬m job item cha Ä‘á»ƒ láº¥y lÆ°Æ¡ng (Æ°u tiÃªn .job_list-item)\n      let salary = null;\n      let jobCard = item.closest(\".job_list-item, .job-item, .job-list-item, .job-card, [class*='job-item'], [class*='job-card'], [class*='job_list']\");\n      if (jobCard) {\n        // TÃ¬m lÆ°Æ¡ng trong .job_list-item-info .salary (theo HTML structure thá»±c táº¿)\n        const jobInfo = jobCard.querySelector(\".job_list-item-info, .job-item-info, [class*='info']\");\n        if (jobInfo) {\n          const salaryEl = jobInfo.querySelector(\".salary[title='Má»©c lÆ°Æ¡ng viá»‡c lÃ m'], .salary, .job-salary, [class*='salary'], .wage, [class*='wage'], [class*='luong'], [class*='muc-luong'], .info-salary\");\n          if (salaryEl) {\n            salary = salaryEl.textContent?.trim() || null;\n          }\n        }\n        // Fallback: tÃ¬m trá»±c tiáº¿p trong job card\n        if (!salary) {\n          const salaryEl = jobCard.querySelector(\".salary[title='Má»©c lÆ°Æ¡ng viá»‡c lÃ m'], .salary, .job-salary, [class*='salary'], .wage, [class*='wage'], [class*='luong'], [class*='muc-luong'], .info-salary\");\n          if (salaryEl) {\n            salary = salaryEl.textContent?.trim() || null;\n          }\n        }\n        // Náº¿u khÃ´ng tÃ¬m tháº¥y, tÃ¬m text chá»©a $ hoáº·c lÆ°Æ¡ng\n        if (!salary) {\n          const text = jobCard.textContent || \"\";\n          const salaryMatch = text.match(/(\\$[^\\n]*|Ä‘ang cáº­p nháº­t|khÃ´ng xÃ¡c Ä‘á»‹nh|thá»a thuáº­n|flex)/i);\n          if (salaryMatch) {\n            salary = salaryMatch[0];\n          }\n        }\n      }\n      \n      if (fullUrl && !uniqueJobs.has(fullUrl)) {\n        uniqueJobs.set(fullUrl, { Url: fullUrl, title: title || \"KhÃ´ng cÃ³ tiÃªu Ä‘á»\", salary: salary || \"\" });\n      }\n    });\n    \n    // Lá»c bá» cÃ¡c job cÃ³ lÆ°Æ¡ng \"Ä‘ang cáº­p nháº­t\", \"khÃ´ng xÃ¡c Ä‘á»‹nh\", \"flex\", \"thá»a thuáº­n\"\n    const filteredJobs = Array.from(uniqueJobs.values()).filter(job => {\n      if (!job.salary || job.salary.trim() === \"\") {\n        // Náº¿u khÃ´ng cÃ³ lÆ°Æ¡ng, giá»¯ láº¡i Ä‘á»ƒ check á»Ÿ loop 2\n        return true;\n      }\n      \n      const salaryLower = job.salary.toLowerCase().trim();\n      \n      // Bá» qua náº¿u chá»‰ lÃ  sá»‘ 0, rá»—ng, hoáº·c chá»‰ cÃ³ kÃ½ hiá»‡u $\n      if (salaryLower === \"0\" || salaryLower === \"\" || salaryLower === \"$\" || salaryLower === \"$ \" || salaryLower === \"$\") {\n        return false;\n      }\n      \n      // Danh sÃ¡ch tá»« khÃ³a cáº§n bá» qua (bao gá»“m cÃ¡c biáº¿n thá»ƒ)\n      const skipKeywords = [\n        \"Ä‘ang cáº­p nháº­t\", \n        \"cáº­p nháº­t\", \n        \"Ä‘ang cáº­p nháº­t\", \n        \"Ä‘ang cáº­p nháº­t\", \n        \"khÃ´ng xÃ¡c Ä‘á»‹nh\", \n        \"thá»a thuáº­n\", \n        \"flex\", \n        \"flexible\",\n        \"updating\",\n        \"not specified\",\n        \"negotiable\"\n      ];\n      \n      // Kiá»ƒm tra náº¿u lÆ°Æ¡ng chá»©a báº¥t ká»³ tá»« khÃ³a nÃ o\n      const shouldSkip = skipKeywords.some(keyword => salaryLower.includes(keyword));\n      \n      if (shouldSkip) {\n        console.log(`âš ï¸ Bá» qua job cÃ³ lÆ°Æ¡ng: ${job.salary}`);\n        return false;\n      }\n      \n      // Chá»‰ giá»¯ láº¡i job cÃ³ lÆ°Æ¡ng há»£p lá»‡ (cÃ³ sá»‘ tiá»n cá»¥ thá»ƒ)\n      return true;\n    });\n    \n    return filteredJobs;\n  });\n\n  console.log(`âœ… Trang ${currentPage} cÃ³ ${jobsOnPage.length} job`);\n  if (jobsOnPage.length === 0) break;\n\n  // --- Gáº®N SOURCE + MAJOR ---\n  const mappedJobs = jobsOnPage.map((j) => ({\n    Source: baseUrl,\n    Url: j.Url,\n    link: j.Url,\n    title: j.title,\n    Major: major\n  }));\n\n  allJobs.push(...mappedJobs);\n\n  // ğŸŸ© KIá»‚M TRA GIá»šI Háº N Sá» LÆ¯á»¢NG JOB\n  if (allJobs.length >= MAX_JOBS) {\n    console.log(`ğŸ›‘ ÄÃ£ Ä‘áº¡t giá»›i háº¡n ${MAX_JOBS} job, dá»«ng láº¡i!`);\n    allJobs = allJobs.slice(0, MAX_JOBS); // Cáº¯t bá»›t náº¿u vÆ°á»£t quÃ¡\n    break;\n  }\n\n  // ğŸŸ© KIá»‚M TRA GIá»šI Háº N Sá» TRANG\n  if (currentPage >= MAX_PAGES) {\n    console.log(`ğŸ›‘ ÄÃ£ Ä‘áº¡t giá»›i háº¡n ${MAX_PAGES} trang, dá»«ng láº¡i!`);\n    break;\n  }\n\n  // --- KIá»‚M TRA XEM CÃ’N TRANG KHÃ”NG (123job.vn pagination) ---\n  const nextExists = await $page.evaluate(() => {\n    // Thá»­ nhiá»u selector phÃ¢n trang\n    return !!(\n      document.querySelector(\".pagination .next:not(.disabled)\") ||\n      document.querySelector(\".pagination a[aria-label='Next']\") ||\n      document.querySelector(\".pagination .page-item.active + .page-item:not(.disabled)\") ||\n      document.querySelector(\"a[href*='page=']:not([href*='page=1'])\") ||\n      document.querySelector(\".next-page, .pagination-next\")\n    );\n  });\n  \n  if (!nextExists) {\n    console.log(\"ğŸ›‘ Háº¿t trang, dá»«ng!\");\n    break;\n  }\n\n  currentPage++;\n  await sleep(800);\n}\n\nconsole.log(\"ğŸ¯ Tá»•ng sá»‘ viá»‡c lÃ m:\", allJobs.length);\n\n// Tráº£ vá» dáº¡ng array cho n8n\nreturn allJobs.map(job => ({ json: job }));",
        "options": {
          "args": [
            "--no-sandbox",
            "--disable-setuid-sandbox",
            "--disable-dev-shm-usage",
            "--disable-accelerated-2d-canvas",
            "--no-first-run",
            "--no-zygote",
            "--disable-gpu"
          ]
        }
      },
      "type": "n8n-nodes-puppeteer.puppeteer",
      "typeVersion": 1,
      "position": [
        -640,
        -80
      ],
      "id": "830997c1-c58b-4fea-bacf-856fe44d682f",
      "name": "Truy cáº­p vÃ o link láº¥y ra cÃ´ng viá»‡c",
      "alwaysOutputData": true,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM",
          "mode": "list",
          "cachedResultName": "123Job",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1293046103,
          "mode": "list",
          "cachedResultName": "danh sÃ¡ch cÃ´ng viá»‡c Ä‘Ã£ crawl",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit#gid=1293046103"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "LÆ°Æ¡ng": "={{ $json[\"LÆ°Æ¡ng\"] }}",
            "TrÃ¬nh Ä‘á»™": "={{ $json[\"TrÃ¬nh Ä‘á»™\"] }}",
            "Sá»‘ lÆ°á»£ng": "={{ $json[\"Sá»‘ lÆ°á»£ng\"] }}",
            "Kinh nghiá»‡m": "={{ $json[\"Kinh nghiá»‡m\"] }}",
            "NgÃ y Ä‘Äƒng": "={{ $json[\"NgÃ y Ä‘Äƒng\"] }}",
            "Vá»‹ trÃ­": "={{ $json[\"Vá»‹ trÃ­\"] }}",
            "Háº¡n tuyá»ƒn dá»¥ng": "={{ $json[\"Háº¡n tuyá»ƒn dá»¥ng\"] }}",
            "ChuyÃªn ngÃ nh": "={{ $json[\"ChuyÃªn ngÃ nh\"] }}",
            "TiÃªu Ä‘á» cÃ´ng viá»‡c": "={{ $json[\"TiÃªu Ä‘á» cÃ´ng viá»‡c\"] }}",
            "TÃªn cÃ´ng ty": "={{ $json[\"TÃªn cÃ´ng ty\"] }}",
            "Link": "={{ $json.Link }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "TiÃªu Ä‘á» cÃ´ng viá»‡c",
              "displayName": "TiÃªu Ä‘á» cÃ´ng viá»‡c",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TÃªn cÃ´ng ty",
              "displayName": "TÃªn cÃ´ng ty",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Link",
              "displayName": "Link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "LÆ°Æ¡ng",
              "displayName": "LÆ°Æ¡ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "TrÃ¬nh Ä‘á»™",
              "displayName": "TrÃ¬nh Ä‘á»™",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Vá»‹ trÃ­",
              "displayName": "Vá»‹ trÃ­",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Kinh nghiá»‡m",
              "displayName": "Kinh nghiá»‡m",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Sá»‘ lÆ°á»£ng",
              "displayName": "Sá»‘ lÆ°á»£ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "NgÃ y Ä‘Äƒng",
              "displayName": "NgÃ y Ä‘Äƒng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Háº¡n tuyá»ƒn dá»¥ng",
              "displayName": "Háº¡n tuyá»ƒn dá»¥ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ChuyÃªn ngÃ nh",
              "displayName": "ChuyÃªn ngÃ nh",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        960,
        16
      ],
      "id": "7d13a094-258a-4acc-9aba-029dfe6922a8",
      "name": "ThÃªm Ä‘á»¯ liá»‡u vÃ o sheet danh sÃ¡ch cÃ´ng viá»‡c Ä‘Ã£ crawl",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM",
          "mode": "list",
          "cachedResultName": "123Job",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 2020572363,
          "mode": "list",
          "cachedResultName": "list link tuyá»ƒn dá»¥ng ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit#gid=2020572363"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Url": "={{$json.link }}",
            "Source": "={{ $json.Url }}",
            "Major": "={{ $json.Major }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Source",
              "displayName": "Source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Url",
              "displayName": "Url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Major",
              "displayName": "Major",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -144,
        416
      ],
      "id": "faf7ecc6-0a2f-4688-8bf1-14d5a4c956b2",
      "name": "ThÃªm Ä‘á»¯ liá»‡u vÃ o sheet list link tuyá»ƒn dá»¥ng",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        720,
        304
      ],
      "id": "b97de449-6491-4347-906e-87af6a0e2079",
      "name": "Láº·p láº¡i xá»­ lÃ½",
      "retryOnFail": true,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -928,
        320
      ],
      "id": "a4fb5842-f8f1-4a36-a556-3797cdea161e",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM",
          "mode": "list",
          "cachedResultName": "123Job",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 2020572363,
          "mode": "list",
          "cachedResultName": "list link tuyá»ƒn dá»¥ng ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit#gid=2020572363"
        },
        "keepFirstRow": true
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1200,
        128
      ],
      "id": "7ed5d90c-d0fc-47c0-832f-c04ac0570e02",
      "name": "XÃ³a Ä‘á»¯ liá»‡u cá»§a sheet list link tuyá»ƒn dá»¥ng",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "runCustomScript",
        "scriptCode": "// ğŸŸ© Bá»c toÃ n bá»™ trong try-catch Ä‘á»ƒ bá» qua link lá»—i\ntry {\n// ğŸŸ© Láº¥y biáº¿n tá»« input JSON\nconst { Url, Major } = $json;\n\n// ğŸŸ© Chuáº©n hÃ³a URL\nlet jobUrl = (Url || \"\").trim();\nif (!jobUrl) {\n  console.log(\"âš ï¸ Bá» qua: KhÃ´ng cÃ³ URL há»£p lá»‡\");\n  return [];\n}\nif (jobUrl.startsWith(\"/\")) jobUrl = \"https://123job.vn\" + jobUrl;\n\n// ğŸŸ© ThÃªm User-Agent Ä‘á»ƒ trÃ¡nh bá»‹ cháº·n\nawait $page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');\n\n// ğŸŸ© ThÃªm extra headers\nawait $page.setExtraHTTPHeaders({\n  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',\n  'Accept-Language': 'vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7',\n  'Accept-Encoding': 'gzip, deflate, br',\n  'Connection': 'keep-alive',\n  'Upgrade-Insecure-Requests': '1'\n});\n\n// ğŸŸ© Giáº£m táº£i request rÃ¡c (Tá»I Æ¯U)\nawait $page.setRequestInterception(true);\n$page.on(\"request\", (req) => {\n  const t = req.resourceType();\n  const u = req.url();\n  if (\n    [\"image\", \"font\", \"media\"].includes(t) ||\n    /doubleclick|googletagmanager|analytics|facebook|adsystem|adservice|hotjar|mixpanel/i.test(u)\n  ) return req.abort();\n  req.continue();\n});\n\n// ğŸŸ© Delay trÆ°á»›c khi truy cáº­p Ä‘á»ƒ trÃ¡nh bá»‹ cháº·n\nawait new Promise(r => setTimeout(r, 1000 + Math.random() * 2000));\n\n// ğŸŸ© Retry logic vá»›i exponential backoff\nlet retries = 3;\nlet lastError = null;\nwhile (retries > 0) {\n  try {\n    // ğŸŸ© Truy cáº­p trang vá»›i timeout tÄƒng lÃªn\n    await $page.goto(jobUrl, { \n      waitUntil: \"networkidle2\", \n      timeout: 60000 \n    });\n    break; // ThÃ nh cÃ´ng, thoÃ¡t khá»i retry loop\n  } catch (error) {\n    lastError = error;\n    retries--;\n    if (retries > 0) {\n      const delay = Math.pow(2, 3 - retries) * 2000; // 2s, 4s, 8s\n      console.log(`âš ï¸ Lá»—i khi truy cáº­p ${jobUrl}, retry sau ${delay}ms... (cÃ²n ${retries} láº§n)`);\n      await new Promise(r => setTimeout(r, delay));\n    } else {\n      console.log(`âŒ KhÃ´ng thá»ƒ truy cáº­p ${jobUrl} sau 3 láº§n thá»­`);\n      // Thá»­ vá»›i domcontentloaded náº¿u networkidle2 fail\n      try {\n        await $page.goto(jobUrl, { waitUntil: \"domcontentloaded\", timeout: 30000 });\n      } catch (e) {\n        console.log(`âŒ Bá» qua link ${jobUrl} do lá»—i: ${lastError.message}`);\n        return []; // Bá» qua link nÃ y, tiáº¿p tá»¥c vá»›i link khÃ¡c\n      }\n    }\n  }\n}\n\n// ğŸŸ© Chá» trang load hoÃ n toÃ n\nawait new Promise(r => setTimeout(r, 2000));\n\n// ğŸŸ© Chá» tiÃªu Ä‘á» xuáº¥t hiá»‡n (123job.vn selectors) - tÄƒng timeout\ntry {\n  await $page.waitForSelector(\"h1.job-title, h1.js-job, body\", { timeout: 30000 });\n} catch (e) {\n  console.log(\"âš ï¸ KhÃ´ng tÃ¬m tháº¥y tiÃªu Ä‘á», tiáº¿p tá»¥c...\");\n  // Kiá»ƒm tra xem cÃ³ bá»‹ redirect hoáº·c block khÃ´ng\n  const currentUrl = $page.url();\n  if (currentUrl.includes('blocked') || currentUrl.includes('error') || currentUrl !== jobUrl) {\n    console.log(`âš ï¸ URL bá»‹ thay Ä‘á»•i: ${currentUrl} (gá»‘c: ${jobUrl})`);\n  }\n}\n\n// ğŸŸ© Má»Ÿ rá»™ng cÃ¡c pháº§n Xem thÃªm (123job.vn)\nfor (let i = 0; i < 5; i++) {\n  const clicked = await $page.evaluate(() => {\n    let c = 0;\n    const allButtons = document.querySelectorAll('button, a, span[onclick], div[onclick], .btn-collapse, .toggle-attr-item');\n    allButtons.forEach(btn => {\n      const text = btn.textContent?.toLowerCase() || '';\n      if (text.includes('xem thÃªm') && btn.offsetParent && !btn.disabled) {\n        btn.click();\n        c++;\n      }\n    });\n    return c;\n  });\n  if (!clicked) break;\n  await new Promise(r => setTimeout(r, 300));\n}\n\n// ğŸŸ© Cuá»™n Ä‘á»ƒ táº£i háº¿t ná»™i dung\nawait $page.evaluate(async () => {\n  await new Promise(res => {\n    let y = 0;\n    const step = 1000;\n    const t = setInterval(() => {\n      window.scrollBy(0, step);\n      y += step;\n      if (y > document.body.scrollHeight + 1200) {\n        clearInterval(t);\n        res();\n      }\n    }, 80);\n  });\n});\nawait new Promise(r => setTimeout(r, 300));\n\n// ğŸŸ© Thu tháº­p dá»¯ liá»‡u chÃ­nh (123job.vn - TARGET ÄÃšNG HTML)\nconst job = await $page.evaluate((Major) => {\n  const get = (sel) => {\n    try {\n      const el = document.querySelector(sel);\n      return el?.textContent?.trim() || null;\n    } catch { return null; }\n  };\n  \n  // === HÃ m tÃ¬m trong .attr-item theo .name-attr ===\n  const findByAttrItem = (nameLabels, defaultValue = null) => {\n    const attrItems = document.querySelectorAll(\".attr-item, .attr-item-groups .attr-item, #tab-attr .attr-item\");\n    for (const item of attrItems) {\n      const nameAttr = item.querySelector(\".name-attr\")?.textContent?.trim() || \"\";\n      for (const label of nameLabels) {\n        if (nameAttr.toLowerCase().includes(label.toLowerCase())) {\n          const textAttr = item.querySelector(\".text-attr\")?.textContent?.trim() || \"\";\n          if (textAttr && textAttr.length > 0) {\n            return textAttr;\n          }\n        }\n      }\n    }\n    return defaultValue;\n  };\n\n  // === Láº¥y tiÃªu Ä‘á» (h1.job-title strong) ===\n  const title = get(\"h1.job-title strong\") || get(\"h1.js-job.job-title strong\") || get(\"h1.job-title\") || get(\"h1\") || \"KhÃ´ng xÃ¡c Ä‘á»‹nh\";\n\n  // === Láº¥y tÃªn cÃ´ng ty (.company-name h2) ===\n  let company = get(\".company-name h2\") || get(\".company-info .company-name h2\") || get(\".company-info-mobile .text-bold\");\n  \n  // LÃ m sáº¡ch tÃªn cÃ´ng ty\n  if (company) {\n    company = company.trim();\n    if (company.includes(\"Quy mÃ´:\")) {\n      company = company.split(/Quy mÃ´:|Trá»¥ sá»Ÿ:/i)[0].trim();\n    }\n    if (company.includes(\"Trá»¥ sá»Ÿ:\")) {\n      company = company.split(/Trá»¥ sá»Ÿ:/i)[0].trim();\n    }\n  } else {\n    company = \"KhÃ´ng xÃ¡c Ä‘á»‹nh\";\n  }\n\n  // === Láº¥y lÆ°Æ¡ng (.attr-item-head .attr-item .value span vá»›i icon la-money) ===\n  let salary = null;\n  const attrItemHead = document.querySelector(\".attr-item-head\");\n  if (attrItemHead) {\n    const attrItems = attrItemHead.querySelectorAll(\".attr-item\");\n    for (const item of attrItems) {\n      const icon = item.querySelector(\".icon-attr-header i\");\n      if (icon && icon.classList.contains(\"la-money\")) {\n        const valueEl = item.querySelector(\".value span\");\n        if (valueEl) {\n          salary = valueEl.textContent?.trim() || null;\n          break;\n        }\n      }\n    }\n  }\n  \n  // Fallback\n  if (!salary) {\n    salary = findByAttrItem([\"Má»©c lÆ°Æ¡ng\", \"LÆ°Æ¡ng\"], null);\n  }\n  \n  // Cáº¯t bá» pháº§n mÃ´ táº£ phÃ­a sau\n  if (salary) {\n    salary = salary.split(/Má»©c lÆ°Æ¡ng phá»• biáº¿n|má»©c lÆ°Æ¡ng phá»• biáº¿n|ThÃ´ng tin thÃªm|thÃ´ng tin thÃªm|MÃ´ táº£|mÃ´ táº£/i)[0].trim();\n    // LÃ m sáº¡ch: \"Äang cáº­p nháº­t\" => Ä‘á»ƒ trá»‘ng\n    if (salary && (salary.toLowerCase().includes(\"Ä‘ang cáº­p nháº­t\") || salary.toLowerCase().includes(\"cáº­p nháº­t\"))) {\n      salary = \"\";\n    }\n  } else {\n    salary = \"\";\n  }\n  \n  // ğŸŸ© Chuyá»ƒn Ä‘á»•i USD sang VNÄ vÃ  format theo Xtr-Ytr VNÄ/thÃ¡ng\n  const USD_TO_VND = 24500;\n  if (salary && (salary.includes(\"$\") || salary.includes(\"USD\") || salary.includes(\"dollar\"))) {\n    const usdMatches = Array.from(salary.matchAll(/\\$?([\\d,]+(?:\\.[\\d]+)?)/g));\n    \n    if (usdMatches.length > 0) {\n      const amounts = usdMatches.map(match => {\n        const usdAmount = parseFloat(match[1].replace(/,/g, \"\"));\n        const vndAmount = Math.round(usdAmount * USD_TO_VND);\n        const trieu = (vndAmount / 1000000).toFixed(1);\n        return parseFloat(trieu).toString().replace(/\\.0$/, \"\") + \"tr\";\n      });\n      \n      if (amounts.length === 1) {\n        salary = amounts[0] + \" VNÄ/thÃ¡ng\";\n      } else if (amounts.length === 2) {\n        salary = amounts[0] + \"-\" + amounts[1] + \" VNÄ/thÃ¡ng\";\n      } else {\n        const nums = amounts.map(a => parseFloat(a.replace(/tr/, \"\")));\n        const min = Math.min(...nums);\n        const max = Math.max(...nums);\n        salary = min + \"tr-\" + max + \"tr VNÄ/thÃ¡ng\";\n      }\n    }\n  }\n\n  // === Láº¥y cÃ¡c thÃ´ng tin tá»« .attr-item ===\n  let deadline = findByAttrItem([\"Háº¡n ná»™p há»“ sÆ¡\", \"Háº¡n tuyá»ƒn dá»¥ng\", \"Háº¿t háº¡n\"], \"KhÃ´ng xÃ¡c Ä‘á»‹nh\");\n  let education = findByAttrItem([\"TrÃ¬nh Ä‘á»™ yÃªu cáº§u\", \"TrÃ¬nh Ä‘á»™\", \"Há»c váº¥n\"], \"KhÃ´ng xÃ¡c Ä‘á»‹nh\");\n  let position = findByAttrItem([\"Cáº¥p báº­c\", \"Vá»‹ trÃ­\", \"Chá»©c vá»¥\"], \"KhÃ´ng xÃ¡c Ä‘á»‹nh\");\n  let experience = findByAttrItem([\"Kinh nghiá»‡m yÃªu cáº§u\", \"Kinh nghiá»‡m\"], \"KhÃ´ng xÃ¡c Ä‘á»‹nh\");\n  let quantity = findByAttrItem([\"Sá»‘ lÆ°á»£ng cáº§n tuyá»ƒn\", \"Sá»‘ lÆ°á»£ng\"], \"KhÃ´ng xÃ¡c Ä‘á»‹nh\");\n  let postedDate = new Date().toISOString().split(\"T\")[0];\n\n  // === LÃ m sáº¡ch dá»¯ liá»‡u ===\n  // LÃ m sáº¡ch trÃ¬nh Ä‘á»™\n  if (education && education.toLowerCase().includes(\"yÃªu cáº§u\")) {\n    education = education.replace(/^yÃªu cáº§u\\s*/i, \"\").trim();\n  }\n  if (education && (education.includes(\"Tráº¯c nghiá»‡m\") || education.includes(\"MBTI\") || education.includes(\"MI\"))) {\n    education = \"\";\n  }\n  // \"KhÃ´ng xÃ¡c Ä‘á»‹nh\" => Ä‘á»ƒ trá»‘ng\n  if (education && education.toLowerCase().includes(\"khÃ´ng xÃ¡c Ä‘á»‹nh\")) {\n    education = \"\";\n  }\n  // Chuyá»ƒn \"associate degree\" sang tiáº¿ng Viá»‡t\n  if (education && education.toLowerCase().includes(\"associate degree\")) {\n    education = \"Cao Ä‘áº³ng\";\n  }\n  \n  // LÃ m sáº¡ch vá»‹ trÃ­\n  if (position && (position.includes(\"Tráº¯c nghiá»‡m\") || position.includes(\"MBTI\") || position.includes(\"MI\"))) {\n    position = \"KhÃ´ng xÃ¡c Ä‘á»‹nh\";\n  }\n  \n  // LÃ m sáº¡ch kinh nghiá»‡m\n  if (experience && experience.toLowerCase().includes(\"yÃªu cáº§u\")) {\n    experience = experience.replace(/^yÃªu cáº§u\\s*/i, \"\").trim();\n  }\n  if (experience && (experience.includes(\"OccupationalExperienceRequirements\") || experience.includes(\"lÃ  Ä‘iá»ƒm cá»™ng\") || experience.includes(\"Cáº­p nháº­t\"))) {\n    experience = \"\";\n  }\n  // \"KhÃ´ng xÃ¡c Ä‘á»‹nh\" => Ä‘á»ƒ trá»‘ng\n  if (experience && experience.toLowerCase().includes(\"khÃ´ng xÃ¡c Ä‘á»‹nh\")) {\n    experience = \"\";\n  }\n  // Náº¿u chá»‰ lÃ  sá»‘ (lá»—i) => Ä‘á»ƒ trá»‘ng\n  if (experience && /^\\s*\\d+\\s*$/.test(experience)) {\n    experience = \"\";\n  }\n  \n  // LÃ m sáº¡ch sá»‘ lÆ°á»£ng\n  if (quantity && quantity.toLowerCase().includes(\"cáº§n tuyá»ƒn\")) {\n    quantity = quantity.replace(/^cáº§n tuyá»ƒn\\s*/i, \"\").trim();\n  }\n  if (quantity && (quantity.includes(\"Äang Cáº­p Nháº­t\") || quantity.includes(\"Cáº­p nháº­t\"))) {\n    quantity = \"\";\n  }\n  // \"KhÃ´ng xÃ¡c Ä‘á»‹nh\" => Ä‘á»ƒ trá»‘ng\n  if (quantity && quantity.toLowerCase().includes(\"khÃ´ng xÃ¡c Ä‘á»‹nh\")) {\n    quantity = \"\";\n  }\n  \n  // LÃ m sáº¡ch háº¡n tuyá»ƒn dá»¥ng\n  if (deadline && (deadline.includes(\"Äáº·c Ä‘iá»ƒm cÃ´ng viá»‡c\") || deadline.includes(\"HÃ¬nh thá»©c lÃ m viá»‡c\") || deadline.includes(\"Cáº¥p báº­c\") || deadline.includes(\"Khu vá»±c\") || deadline.includes(\"Xem thÃªm\"))) {\n    const dateMatch = deadline.match(/(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{2,4})/);\n    deadline = dateMatch ? dateMatch[1] : \"KhÃ´ng xÃ¡c Ä‘á»‹nh\";\n  }\n  if (deadline && (deadline.includes(\"0961.469.398\") || deadline.includes(\"giá» hÃ nh chÃ­nh\"))) {\n    deadline = \"KhÃ´ng xÃ¡c Ä‘á»‹nh\";\n  }\n\n  return {\n    title, company, salary, education, position,\n    experience, quantity, postedDate, deadline,\n    major: Major, link: window.location.href\n  };\n}, Major);\n\n// ğŸŸ© Tráº£ káº¿t quáº£\nreturn [\n  {\n    json: {\n      \"TiÃªu Ä‘á» cÃ´ng viá»‡c\": job.title,\n      \"TÃªn cÃ´ng ty\": job.company,\n      \"Link\": job.link,\n      \"LÆ°Æ¡ng\": job.salary,\n      \"TrÃ¬nh Ä‘á»™\": job.education,\n      \"Vá»‹ trÃ­\": job.position,\n      \"Kinh nghiá»‡m\": job.experience,\n      \"Sá»‘ lÆ°á»£ng\": job.quantity,\n      \"NgÃ y Ä‘Äƒng\": job.postedDate,\n      \"Háº¡n tuyá»ƒn dá»¥ng\": job.deadline,\n      \"ChuyÃªn ngÃ nh\": job.major,\n    },\n  },\n];\n\n} catch (error) {\n  // ğŸŸ© Bá» qua link lá»—i, log vÃ  tiáº¿p tá»¥c vá»›i link khÃ¡c\n  console.log(`âŒ Lá»—i khi xá»­ lÃ½ link ${$json.Url || 'unknown'}: ${error.message}`);\n  return []; // Tráº£ vá» empty Ä‘á»ƒ bá» qua link nÃ y\n}",
        "options": {
          "args": [
            "--no-sandbox",
            "--disable-setuid-sandbox",
            "--disable-dev-shm-usage",
            "--disable-accelerated-2d-canvas",
            "--no-first-run",
            "--no-zygote",
            "--disable-gpu"
          ]
        }
      },
      "type": "n8n-nodes-puppeteer.puppeteer",
      "typeVersion": 1,
      "position": [
        288,
        16
      ],
      "id": "01eb1871-28ed-4395-8e26-29b6038dc458",
      "name": "Truy cáº­p link láº¥y thÃ´ng tin"
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "Láº¥y Ä‘á»¯ liá»‡u sheet list url cáº§n crawl",
            "type": "main",
            "index": 0
          },
          {
            "node": "XÃ³a Ä‘á»¯ liá»‡u cá»§a sheet list link tuyá»ƒn dá»¥ng",
            "type": "main",
            "index": 0
          },
          {
            "node": "XÃ³a danh sÃ¡ch cÃ´ng viá»‡c Ä‘Ã£ crawl",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Láº¥y Ä‘á»¯ liá»‡u sheet list url cáº§n crawl": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Truy cáº­p vÃ o link láº¥y ra cÃ´ng viá»‡c": {
      "main": [
        [
          {
            "node": "ThÃªm Ä‘á»¯ liá»‡u vÃ o sheet list link tuyá»ƒn dá»¥ng",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ThÃªm Ä‘á»¯ liá»‡u vÃ o sheet list link tuyá»ƒn dá»¥ng": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ThÃªm Ä‘á»¯ liá»‡u vÃ o sheet danh sÃ¡ch cÃ´ng viá»‡c Ä‘Ã£ crawl": {
      "main": [
        [
          {
            "node": "Láº·p láº¡i xá»­ lÃ½",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Láº·p láº¡i xá»­ lÃ½": {
      "main": [
        [],
        [
          {
            "node": "Truy cáº­p link láº¥y thÃ´ng tin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Láº·p láº¡i xá»­ lÃ½",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Truy cáº­p vÃ o link láº¥y ra cÃ´ng viá»‡c",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Truy cáº­p link láº¥y thÃ´ng tin": {
      "main": [
        [
          {
            "node": "ThÃªm Ä‘á»¯ liá»‡u vÃ o sheet danh sÃ¡ch cÃ´ng viá»‡c Ä‘Ã£ crawl",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "4f5b2d98-e132-4e40-b956-daf7e4f7841e",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "be4bd479f567f96620153db3fcd673abbd059c76f34103f7251e61fb5e9ec621"
  },
  "id": "QNZIXG49gtXSI6sB",
  "tags": []
}