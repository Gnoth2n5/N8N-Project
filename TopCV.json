{
  "name": "TopCV",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -256,
        352
      ],
      "id": "0fcd4e17-8adb-470b-99b0-56eea19c3eda",
      "name": "When clicking ‚ÄòExecute workflow‚Äô"
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g",
          "mode": "list",
          "cachedResultName": "TopCV",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1293046103,
          "mode": "list",
          "cachedResultName": "danh s√°ch c√¥ng vi·ªác ƒë√£ crawl",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g/edit#gid=1293046103"
        },
        "keepFirstRow": true
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        0,
        0
      ],
      "id": "e46b51d5-e1a8-4ea9-8984-fea8fd2d1c04",
      "name": "X√≥a danh s√°ch c√¥ng vi·ªác ƒë√£ crawl",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g",
          "mode": "list",
          "cachedResultName": "TopCV",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "list url c·∫ßn crawl",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        0,
        352
      ],
      "id": "5d0f49dd-a72e-46c7-b869-e2a089b0b9d1",
      "name": "L·∫•y ƒë·ªØ li·ªáu sheet list url c·∫ßn crawl",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "runCustomScript",
        "scriptCode": "// Helper\nconst sleep = (ms) => new Promise((res) => setTimeout(res, ms));\n\n// L·∫•y input\nlet baseUrl = $json.Url?.trim();\nif (!baseUrl) throw new Error(\"‚ùå Thi·∫øu 'Url' trong input!\");\n\nlet major = $json.Major || $json.major || \"\";\nconst MAX_PAGES = parseInt($json.MaxPages || $json.maxPages || \"5\");\nconst MAX_JOBS = parseInt($json.MaxJobs || $json.maxJobs || \"10\");\n\nlet allJobs = [];\nlet currentPage = 1;\n\n// T·ªëi ∆∞u request\nawait $page.setRequestInterception(true);\n$page.on(\"request\", (req) => {\n  const t = req.resourceType();\n  const u = req.url();\n  if ([\"image\", \"font\", \"media\"].includes(t) || /doubleclick|googletagmanager|analytics|facebook|adsystem|adservice|hotjar|mixpanel/i.test(u)) {\n    return req.abort();\n  }\n  req.continue();\n});\n\nwhile (true) {\n  // T·∫°o URL ph√¢n trang\n  let Url = baseUrl;\n  if (currentPage > 1) {\n    Url = baseUrl.includes(\"?\") ? `${baseUrl}&page=${currentPage}` : `${baseUrl}?page=${currentPage}`;\n  }\n\n  console.log(`üü¶ Trang ${currentPage}: ${Url}`);\n\n  // ƒêi ƒë·∫øn trang\n  await $page.goto(Url, { waitUntil: \"domcontentloaded\", timeout: 30000 });\n\n  // ƒê·ª£i job items xu·∫•t hi·ªán - theo c·∫•u tr√∫c HTML TopCV trong ·∫£nh\n  try {\n    await $page.waitForSelector(\".job-item-search-result\", { timeout: 15000 });\n  } catch {\n    console.log(`‚ö†Ô∏è Kh√¥ng th·∫•y job ·ªü trang ${currentPage}`);\n    break;\n  }\n\n  // Cu·ªôn ƒë·ªÉ load h·∫øt\n  let lastCount = 0;\n  let noChangeCount = 0;\n  for (let i = 0; i < 10; i++) {\n    await $page.evaluate(() => window.scrollBy(0, document.body.scrollHeight));\n    await sleep(500);\n    const currentCount = await $page.$$eval(\".job-item-search-result\", (els) => els.length);\n    if (currentCount === lastCount) {\n      noChangeCount++;\n      if (noChangeCount >= 2) break;\n    } else {\n      noChangeCount = 0;\n    }\n    lastCount = currentCount;\n  }\n\n  // L·∫•y d·ªØ li·ªáu - target ƒë√∫ng HTML structure TopCV theo ·∫£nh\n  const jobsOnPage = await $page.evaluate(() => {\n    // T√¨m t·∫•t c·∫£ job items: .job-item-search-result\n    const jobItems = document.querySelectorAll(\".job-item-search-result\");\n    const uniqueJobs = new Map();\n    \n    jobItems.forEach((item) => {\n      // T√¨m link t·ª´ h3.title a ho·∫∑c a.company trong .title-block\n      const titleBlock = item.querySelector(\".title-block\");\n      if (!titleBlock) return;\n      \n      // T√¨m link trong h3.title\n      let linkEl = titleBlock.querySelector(\"h3.title a\");\n      // N·∫øu kh√¥ng c√≥, t√¨m trong a.company\n      if (!linkEl) {\n        linkEl = titleBlock.querySelector(\"a.company\");\n      }\n      // N·∫øu v·∫´n kh√¥ng c√≥, t√¨m b·∫•t k·ª≥ link n√†o trong title-block\n      if (!linkEl) {\n        linkEl = titleBlock.querySelector(\"a[href*='/viec-lam/'], a[href*='/cong-viec/']\");\n      }\n      \n      if (!linkEl) return;\n      \n      const href = linkEl.getAttribute(\"href\") || linkEl.href || \"\";\n      if (!href || href.includes(\"#\")) return;\n      \n      // Chu·∫©n h√≥a URL\n      let fullUrl = href;\n      if (href.startsWith(\"/\")) {\n        fullUrl = \"https://www.topcv.vn\" + href;\n      } else if (!href.startsWith(\"http\")) {\n        fullUrl = \"https://www.topcv.vn/\" + href;\n      }\n      \n      // L·∫•y ti√™u ƒë·ªÅ t·ª´ h3.title\n      const titleEl = titleBlock.querySelector(\"h3.title\");\n      const title = titleEl?.textContent?.trim() || linkEl.textContent?.trim() || \"\";\n      \n      // L·∫•y l∆∞∆°ng t·ª´ label.title-salary trong .box-right\n      let salary = \"\";\n      const boxRight = item.querySelector(\".box-right\");\n      if (boxRight) {\n        const salaryEl = boxRight.querySelector(\"label.title-salary\");\n        if (salaryEl) {\n          salary = salaryEl.textContent?.trim() || \"\";\n        }\n      }\n      \n      if (fullUrl && !uniqueJobs.has(fullUrl)) {\n        uniqueJobs.set(fullUrl, { Url: fullUrl, title: title || \"Kh√¥ng c√≥ ti√™u ƒë·ªÅ\", salary: salary });\n      }\n    });\n    \n    // L·ªçc job c√≥ l∆∞∆°ng h·ª£p l·ªá\n    const filteredJobs = Array.from(uniqueJobs.values()).filter(job => {\n      if (!job.salary || job.salary.trim() === \"\") {\n        return true; // Gi·ªØ l·∫°i n·∫øu kh√¥ng c√≥ l∆∞∆°ng ƒë·ªÉ check ·ªü loop 2\n      }\n      \n      const salaryLower = job.salary.toLowerCase().trim();\n      \n      // B·ªè qua c√°c t·ª´ kh√≥a kh√¥ng h·ª£p l·ªá\n      const skipKeywords = [\"ƒëang c·∫≠p nh·∫≠t\", \"c·∫≠p nh·∫≠t\", \"kh√¥ng x√°c ƒë·ªãnh\", \"th·ªèa thu·∫≠n\", \"flex\", \"flexible\"];\n      const shouldSkip = skipKeywords.some(keyword => salaryLower.includes(keyword));\n      \n      if (shouldSkip) {\n        return false;\n      }\n      \n      return true;\n    });\n    \n    return filteredJobs;\n  });\n\n  console.log(`‚úÖ Trang ${currentPage} c√≥ ${jobsOnPage.length} job`);\n  if (jobsOnPage.length === 0) break;\n\n  // G·∫Øn Source + Major\n  const mappedJobs = jobsOnPage.map((j) => ({\n    Source: baseUrl,\n    Url: j.Url,\n    link: j.Url,\n    title: j.title,\n    Major: major\n  }));\n\n  allJobs.push(...mappedJobs);\n\n  // Ki·ªÉm tra gi·ªõi h·∫°n\n  if (allJobs.length >= MAX_JOBS) {\n    console.log(`üõë ƒê√£ ƒë·∫°t gi·ªõi h·∫°n ${MAX_JOBS} job`);\n    allJobs = allJobs.slice(0, MAX_JOBS);\n    break;\n  }\n\n  if (currentPage >= MAX_PAGES) {\n    console.log(`üõë ƒê√£ ƒë·∫°t gi·ªõi h·∫°n ${MAX_PAGES} trang`);\n    break;\n  }\n\n  // Ki·ªÉm tra c√≤n trang kh√¥ng\n  const nextExists = await $page.evaluate(() => {\n    return !!(\n      document.querySelector(\".pagination .next:not(.disabled)\") ||\n      document.querySelector(\"a[href*='page=']:not([href*='page=1'])\") ||\n      document.querySelector(\".next-page, .pagination-next\")\n    );\n  });\n  \n  if (!nextExists) {\n    console.log(\"üõë H·∫øt trang\");\n    break;\n  }\n\n  currentPage++;\n  await sleep(800);\n}\n\nconsole.log(\"üéØ T·ªïng s·ªë vi·ªác l√†m:\", allJobs.length);\n\nreturn allJobs.map(job => ({ json: job }));",
        "options": {
          "args": [
            "--no-sandbox",
            "--disable-setuid-sandbox",
            "--disable-dev-shm-usage",
            "--disable-accelerated-2d-canvas",
            "--no-first-run",
            "--no-zygote",
            "--disable-gpu"
          ]
        }
      },
      "type": "n8n-nodes-puppeteer.puppeteer",
      "typeVersion": 1,
      "position": [
        608,
        448
      ],
      "id": "6e33a6e0-310c-4bd0-ad8c-48d5203dee25",
      "name": "Truy c·∫≠p v√†o link l·∫•y ra c√¥ng vi·ªác",
      "alwaysOutputData": true,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g",
          "mode": "list",
          "cachedResultName": "TopCV",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1293046103,
          "mode": "list",
          "cachedResultName": "danh s√°ch c√¥ng vi·ªác ƒë√£ crawl",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit#gid=1293046103"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "L∆∞∆°ng": "={{ $json[\"L∆∞∆°ng\"] }}",
            "Tr√¨nh ƒë·ªô": "={{ $json[\"Tr√¨nh ƒë·ªô\"] }}",
            "S·ªë l∆∞·ª£ng": "={{ $json[\"S·ªë l∆∞·ª£ng\"] }}",
            "Kinh nghi·ªám": "={{ $json[\"Kinh nghi·ªám\"] }}",
            "Ng√†y ƒëƒÉng": "={{ $json[\"Ng√†y ƒëƒÉng\"] }}",
            "V·ªã tr√≠": "={{ $json[\"V·ªã tr√≠\"] }}",
            "H·∫°n tuy·ªÉn d·ª•ng": "={{ $json[\"H·∫°n tuy·ªÉn d·ª•ng\"] }}",
            "Chuy√™n ng√†nh": "={{ $json[\"Chuy√™n ng√†nh\"] }}",
            "Ti√™u ƒë·ªÅ c√¥ng vi·ªác": "={{ $json[\"Ti√™u ƒë·ªÅ c√¥ng vi·ªác\"] }}",
            "T√™n c√¥ng ty": "={{ $json[\"T√™n c√¥ng ty\"] }}",
            "Link": "={{ $json.Link }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Ti√™u ƒë·ªÅ c√¥ng vi·ªác",
              "displayName": "Ti√™u ƒë·ªÅ c√¥ng vi·ªác",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "T√™n c√¥ng ty",
              "displayName": "T√™n c√¥ng ty",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Link",
              "displayName": "Link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "L∆∞∆°ng",
              "displayName": "L∆∞∆°ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Tr√¨nh ƒë·ªô",
              "displayName": "Tr√¨nh ƒë·ªô",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "V·ªã tr√≠",
              "displayName": "V·ªã tr√≠",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Kinh nghi·ªám",
              "displayName": "Kinh nghi·ªám",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "S·ªë l∆∞·ª£ng",
              "displayName": "S·ªë l∆∞·ª£ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Ng√†y ƒëƒÉng",
              "displayName": "Ng√†y ƒëƒÉng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "H·∫°n tuy·ªÉn d·ª•ng",
              "displayName": "H·∫°n tuy·ªÉn d·ª•ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Chuy√™n ng√†nh",
              "displayName": "Chuy√™n ng√†nh",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2160,
        48
      ],
      "id": "c4209669-8b4b-456c-9a17-e10f6f41532d",
      "name": "Th√™m ƒë·ªØ li·ªáu v√†o sheet danh s√°ch c√¥ng vi·ªác ƒë√£ crawl",
      "onError": "continueRegularOutput",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g",
          "mode": "list",
          "cachedResultName": "TopCV",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 2020572363,
          "mode": "list",
          "cachedResultName": "list link tuy·ªÉn d·ª•ng ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i077qGPoAgK1XLcbCLziqppsyFjwllMOpevn06Y1tXM/edit#gid=2020572363"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Url": "={{$json.link }}",
            "Source": "={{ $json.Source }}",
            "Major": "={{ $json.Major }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Source",
              "displayName": "Source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Url",
              "displayName": "Url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Major",
              "displayName": "Major",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1056,
        448
      ],
      "id": "ccf5d39b-1d12-404e-864b-88b395b07446",
      "name": "Th√™m ƒë·ªØ li·ªáu v√†o sheet list link tuy·ªÉn d·ª•ng",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1920,
        336
      ],
      "id": "363bb94e-1f71-445a-bab6-2d8cfa8ed8d3",
      "name": "L·∫∑p l·∫°i x·ª≠ l√Ω",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        272,
        352
      ],
      "id": "440ac3fe-1429-442f-b983-b58f8c334146",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g",
          "mode": "list",
          "cachedResultName": "TopCV",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 2020572363,
          "mode": "list",
          "cachedResultName": "list link tuy·ªÉn d·ª•ng ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1khrx3uLRRRLLesTwo4zfTeLZo9aksNx9xWON1u2ky0g/edit#gid=2020572363"
        },
        "keepFirstRow": true
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        0,
        160
      ],
      "id": "4fbe76de-e05e-4268-bbf3-bd79c7954264",
      "name": "X√≥a ƒë·ªØ li·ªáu c·ªßa sheet list link tuy·ªÉn d·ª•ng",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "runCustomScript",
        "scriptCode": "// üü© B·ªçc to√†n b·ªô trong try-catch ƒë·ªÉ b·ªè qua link l·ªói\ntry {\n// L·∫•y bi·∫øn t·ª´ input\nconst { Url, Major } = $json;\n\n// Chu·∫©n h√≥a URL\nlet jobUrl = (Url || \"\").trim();\nif (!jobUrl) {\n  console.log(\"‚ö†Ô∏è B·ªè qua: Kh√¥ng c√≥ URL h·ª£p l·ªá\");\n  return [   {     json: {       skip: true,       Link: jobUrl || "",       message: "URL l·ªói, b·ªè qua"     }   } ];\n}\nif (jobUrl.startsWith(\"/\")) jobUrl = \"https://www.topcv.vn\" + jobUrl;\nelse if (!jobUrl.startsWith(\"http\")) jobUrl = \"https://www.topcv.vn/\" + jobUrl;\n\n// üü© Th√™m User-Agent ƒë·ªÉ tr√°nh b·ªã ch·∫∑n\nawait $page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');\n\n// üü© Th√™m extra headers\nawait $page.setExtraHTTPHeaders({\n  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',\n  'Accept-Language': 'vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7',\n  'Accept-Encoding': 'gzip, deflate, br',\n  'Connection': 'keep-alive',\n  'Upgrade-Insecure-Requests': '1'\n});\n\n// T·ªëi ∆∞u request\nawait $page.setRequestInterception(true);\n$page.on(\"request\", (req) => {\n  const t = req.resourceType();\n  const u = req.url();\n  if ([\"image\", \"font\", \"media\"].includes(t) || /doubleclick|googletagmanager|analytics|facebook|adsystem|adservice|hotjar|mixpanel/i.test(u)) {\n    return req.abort();\n  }\n  req.continue();\n});\n\n// üü© Delay tr∆∞·ªõc khi truy c·∫≠p ƒë·ªÉ tr√°nh b·ªã ch·∫∑n\nawait new Promise(r => setTimeout(r, 1000 + Math.random() * 2000));\n\n// üü© Retry logic v·ªõi exponential backoff\nlet retries = 3;\nlet lastError = null;\nwhile (retries > 0) {\n  try {\n    // üü© Truy c·∫≠p trang v·ªõi timeout tƒÉng l√™n\n    await $page.goto(jobUrl, { \n      waitUntil: \"networkidle2\", \n      timeout: 60000 \n    });\n    break; // Th√†nh c√¥ng, tho√°t kh·ªèi retry loop\n  } catch (error) {\n    lastError = error;\n    retries--;\n    if (retries > 0) {\n      const delay = Math.pow(2, 3 - retries) * 2000; // 2s, 4s, 8s\n      console.log(`‚ö†Ô∏è L·ªói khi truy c·∫≠p ${jobUrl}, retry sau ${delay}ms... (c√≤n ${retries} l·∫ßn)`);\n      await new Promise(r => setTimeout(r, delay));\n    } else {\n      console.log(`‚ùå Kh√¥ng th·ªÉ truy c·∫≠p ${jobUrl} sau 3 l·∫ßn th·ª≠`);\n      // Th·ª≠ v·ªõi domcontentloaded n·∫øu networkidle2 fail\n      try {\n        await $page.goto(jobUrl, { waitUntil: \"domcontentloaded\", timeout: 30000 });\n      } catch (e) {\n        console.log(`‚ùå B·ªè qua link ${jobUrl} do l·ªói: ${lastError.message}`);\n        return [   {     json: {       skip: true,       Link: jobUrl || "",       message: "URL l·ªói, b·ªè qua"     }   } ]; // B·ªè qua link n√†y, ti·∫øp t·ª•c v·ªõi link kh√°c\n      }\n    }\n  }\n}\n\n// üü© Ch·ªù trang load ho√†n to√†n\nawait new Promise(r => setTimeout(r, 2000));\n\n// Ch·ªù ti√™u ƒë·ªÅ xu·∫•t hi·ªán - theo c·∫•u tr√∫c TopCV - tƒÉng timeout\ntry {\n  await $page.waitForSelector(\"h1.job-detail__info--title, body\", { timeout: 30000 });\n} catch (e) {\n  console.log(\"‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ti√™u ƒë·ªÅ, ti·∫øp t·ª•c...\");\n  // Ki·ªÉm tra xem c√≥ b·ªã redirect ho·∫∑c block kh√¥ng\n  const currentUrl = $page.url();\n  if (currentUrl.includes('blocked') || currentUrl.includes('error') || currentUrl !== jobUrl) {\n    console.log(`‚ö†Ô∏è URL b·ªã thay ƒë·ªïi: ${currentUrl} (g·ªëc: ${jobUrl})`);\n  }\n}\n\n// Cu·ªôn ƒë·ªÉ t·∫£i h·∫øt n·ªôi dung\nawait $page.evaluate(async () => {\n  await new Promise(res => {\n    let y = 0;\n    const step = 1000;\n    const t = setInterval(() => {\n      window.scrollBy(0, step);\n      y += step;\n      if (y > document.body.scrollHeight + 1200) {\n        clearInterval(t);\n        res();\n      }\n    }, 80);\n  });\n});\nawait new Promise(r => setTimeout(r, 300));\n\n// Thu th·∫≠p d·ªØ li·ªáu - target ƒë√∫ng HTML structure c·ªßa TopCV\nconst job = await $page.evaluate((Major) => {\n  const get = (sel) => {\n    try {\n      const el = document.querySelector(sel);\n      return el?.textContent?.trim() || null;\n    } catch { return null; }\n  };\n  \n  // H√†m t√¨m th√¥ng tin trong job-detail__info--sections theo title\n  const findSectionByTitle = (titleKeywords) => {\n    const sections = document.querySelectorAll(\".job-detail__info--section\");\n    for (const section of sections) {\n      const titleEl = section.querySelector(\".job-detail__info--section-content-title\");\n      if (!titleEl) continue;\n      const titleText = titleEl.textContent?.trim() || \"\";\n      for (const keyword of titleKeywords) {\n        if (titleText.toLowerCase().includes(keyword.toLowerCase())) {\n          const valueEl = section.querySelector(\".job-detail__info--section-content-value\");\n          if (valueEl) {\n            return valueEl.textContent?.trim() || \"\";\n          }\n        }\n      }\n    }\n    return null;\n  };\n  \n  // H√†m t√¨m th√¥ng tin trong box-general-group theo title\n  const findBoxGeneralByTitle = (titleKeywords) => {\n    const groups = document.querySelectorAll(\".box-general-group\");\n    for (const group of groups) {\n      const titleEl = group.querySelector(\".box-general-group-info-title\");\n      if (!titleEl) continue;\n      const titleText = titleEl.textContent?.trim() || \"\";\n      for (const keyword of titleKeywords) {\n        if (titleText.toLowerCase().includes(keyword.toLowerCase())) {\n          const valueEl = group.querySelector(\".box-general-group-info-value\");\n          if (valueEl) {\n            return valueEl.textContent?.trim() || \"\";\n          }\n        }\n      }\n    }\n    return null;\n  };\n\n  // L·∫•y ti√™u ƒë·ªÅ t·ª´ h1.job-detail__info--title\n  const titleEl = document.querySelector(\"h1.job-detail__info--title a\") || document.querySelector(\"h1.job-detail__info--title\");\n  const title = titleEl?.textContent?.trim() || \"Kh√¥ng x√°c ƒë·ªãnh\";\n\n  // L·∫•y t√™n c√¥ng ty - t√¨m trong c√°c selector ph·ªï bi·∫øn c·ªßa TopCV\n  let company = get(\".job-detail__company-name\") || \n                get(\".company-info__name\") || \n                get(\".job-detail__body-right .company-name\") ||\n                get(\".job-detail__body-right h3\") ||\n                get(\".company-detail__name\") ||\n                \"Kh√¥ng x√°c ƒë·ªãnh\";\n  company = company.trim();\n\n  // H√†m format l∆∞∆°ng: chuy·ªÉn USD sang tri·ªáu VND v√† format l·∫°i\n  const formatSalary = (salaryText) => {\n    if (!salaryText) return \"\";\n    \n    const text = salaryText.trim();\n    const usdRate = 24500; // T·ª∑ gi√° USD/VND\n    \n    // N·∫øu ƒë√£ c√≥ \"tri·ªáu\" th√¨ gi·ªØ nguy√™n\n    if (/tri·ªáu/i.test(text)) {\n      // Format l·∫°i: \"12 - 17 tri·ªáu\" ho·∫∑c \"T·ª´ 10 tri·ªáu\"\n      const match = text.match(/(\\d+)\\s*-?\\s*(\\d+)?\\s*tri·ªáu/i);\n      if (match) {\n        const min = parseInt(match[1]);\n        const max = match[2] ? parseInt(match[2]) : null;\n        if (max) {\n          return `${min} - ${max} tri·ªáu`;\n        } else {\n          return `${min} tri·ªáu`;\n        }\n      }\n      return text;\n    }\n    \n    // X·ª≠ l√Ω USD\n    if (/USD|\\$/i.test(text)) {\n      // T√¨m s·ªë trong text (c√≥ th·ªÉ c√≥ d·∫•u ph·∫©y)\n      const numbers = text.match(/[\\d,]+/g);\n      if (!numbers || numbers.length === 0) return text;\n      \n      // Chuy·ªÉn ƒë·ªïi s·ªë (b·ªè d·∫•u ph·∫©y)\n      const nums = numbers.map(n => parseFloat(n.replace(/,/g, \"\")));\n      \n      // Chuy·ªÉn USD sang tri·ªáu VND\n      const minUSD = nums[0];\n      const maxUSD = nums.length > 1 ? nums[1] : null;\n      \n      const minVND = Math.round((minUSD * usdRate) / 1000000); // Chia 1,000,000 ƒë·ªÉ c√≥ tri·ªáu\n      const maxVND = maxUSD ? Math.round((maxUSD * usdRate) / 1000000) : null;\n      \n      if (maxVND) {\n        return `${minVND} - ${maxVND} tri·ªáu`;\n      } else {\n        // N·∫øu c√≥ t·ª´ \"T·ªõi\" ho·∫∑c \"T·ª´\"\n        if (/t·ªõi|ƒë·∫øn|up to|max/i.test(text)) {\n          return `T·ªõi ${minVND} tri·ªáu`;\n        } else if (/t·ª´|from|min/i.test(text)) {\n          return `T·ª´ ${minVND} tri·ªáu`;\n        } else {\n          return `${minVND} tri·ªáu`;\n        }\n      }\n    }\n    \n    // N·∫øu kh√¥ng ph·∫£i USD v√† kh√¥ng c√≥ \"tri·ªáu\", th·ª≠ format l·∫°i\n    const numberMatch = text.match(/(\\d+)\\s*-?\\s*(\\d+)?/);\n    if (numberMatch) {\n      const min = parseInt(numberMatch[1]);\n      const max = numberMatch[2] ? parseInt(numberMatch[2]) : null;\n      if (max) {\n        return `${min} - ${max} tri·ªáu`;\n      } else {\n        return `${min} tri·ªáu`;\n      }\n    }\n    \n    return text;\n  };\n\n  // L·∫•y l∆∞∆°ng t·ª´ section c√≥ title \"Thu nh·∫≠p\"\n  let salary = findSectionByTitle([\"Thu nh·∫≠p\", \"M·ª©c l∆∞∆°ng\", \"L∆∞∆°ng\"]) || \"\";\n  salary = formatSalary(salary);\n\n  // L·∫•y kinh nghi·ªám t·ª´ section c√≥ id=\"job-detail-info-experience\" ho·∫∑c title \"Kinh nghi·ªám\"\n  let experience = findSectionByTitle([\"Kinh nghi·ªám\"]) || \"\";\n  if (!experience) {\n    const expSection = document.querySelector(\"#job-detail-info-experience\");\n    if (expSection) {\n      const valueEl = expSection.querySelector(\".job-detail__info--section-content-value\");\n      if (valueEl) experience = valueEl.textContent?.trim() || \"\";\n    }\n  }\n\n  // L·∫•y v·ªã tr√≠ (C·∫•p b·∫≠c) t·ª´ box-general-group\n  let position = findBoxGeneralByTitle([\"C·∫•p b·∫≠c\"]) || \"\";\n\n  // L·∫•y tr√¨nh ƒë·ªô t·ª´ job-tags ph·∫ßn \"Y√™u c·∫ßu\"\n  let education = \"\";\n  const requirementGroup = Array.from(document.querySelectorAll(\".job-tags__group\")).find(group => {\n    const nameEl = group.querySelector(\".job-tags__group-name\");\n    return nameEl && nameEl.textContent?.includes(\"Y√™u c·∫ßu\");\n  });\n  if (requirementGroup) {\n    const tags = requirementGroup.querySelectorAll(\".job-tags__group-list-tag a.item\");\n    for (const tag of tags) {\n      const tagText = tag.textContent?.trim() || \"\";\n      if (/Cao ƒê·∫≥ng|ƒê·∫°i h·ªçc|Trung c·∫•p|Th·∫°c sƒ©|Ti·∫øn sƒ©|C·ª≠ nh√¢n/i.test(tagText)) {\n        education = tagText;\n        break;\n      }\n    }\n  }\n\n  // L·∫•y chuy√™n ng√†nh t·ª´ data ban ƒë·∫ßu (Major)\n  const major = Major || \"\";\n\n  // L·∫•y h·∫°n n·ªôp h·ªì s∆°\n  let deadline = get(\".job-detail__info--deadline-date\") || \"\";\n  if (!deadline) {\n    deadline = get(\".job-detail__information-detail--actions-label\") || \"\";\n    if (deadline) {\n      deadline = deadline.replace(/H·∫°n n·ªôp h·ªì s∆°:/i, \"\").trim();\n    }\n  }\n\n  // L·∫•y s·ªë l∆∞·ª£ng tuy·ªÉn t·ª´ box-general-group\n  let quantity = findBoxGeneralByTitle([\"S·ªë l∆∞·ª£ng tuy·ªÉn\", \"S·ªë l∆∞·ª£ng\"]) || \"\";\n\n  // Ng√†y ƒëƒÉng - c√≥ th·ªÉ kh√¥ng c√≥ trong HTML n√†y\n  const postedDate = \"\";\n\n  // L√†m s·∫°ch d·ªØ li·ªáu\n  const cleanText = (text) => {\n    if (!text) return \"\";\n    return text.trim();\n  };\n\n  return {\n    title: cleanText(title),\n    company: cleanText(company),\n    salary: cleanText(salary),\n    education: cleanText(education),\n    position: cleanText(position),\n    experience: cleanText(experience),\n    quantity: cleanText(quantity),\n    postedDate: cleanText(postedDate),\n    deadline: cleanText(deadline),\n    major: cleanText(major),\n    link: window.location.href\n  };\n}, Major);\n\n// Tr·∫£ k·∫øt qu·∫£\nreturn [\n  {\n    json: {\n      \"Ti√™u ƒë·ªÅ c√¥ng vi·ªác\": job.title,\n      \"T√™n c√¥ng ty\": job.company,\n      \"Link\": job.link,\n      \"L∆∞∆°ng\": job.salary,\n      \"Tr√¨nh ƒë·ªô\": job.education,\n      \"V·ªã tr√≠\": job.position,\n      \"Kinh nghi·ªám\": job.experience,\n      \"S·ªë l∆∞·ª£ng\": job.quantity,\n      \"Ng√†y ƒëƒÉng\": job.postedDate,\n      \"H·∫°n tuy·ªÉn d·ª•ng\": job.deadline,\n      \"Chuy√™n ng√†nh\": job.major,\n    },\n  },\n];\n\n} catch (error) {\n  // üü© B·ªè qua link l·ªói, log v√† ti·∫øp t·ª•c v·ªõi link kh√°c\n  console.log(`‚ùå L·ªói khi x·ª≠ l√Ω link ${$json.Url || 'unknown'}: ${error.message}`);\n  return [   {     json: {       skip: true,       Link: jobUrl || "",       message: "URL l·ªói, b·ªè qua"     }   } ]; // Tr·∫£ v·ªÅ skip ƒë·ªÉ b·ªè qua link n√†y\n}",
        "options": {
          "args": [
            "--no-sandbox",
            "--disable-setuid-sandbox",
            "--disable-dev-shm-usage",
            "--disable-accelerated-2d-canvas",
            "--no-first-run",
            "--no-zygote",
            "--disable-gpu"
          ]
        }
      },
      "type": "n8n-nodes-puppeteer.puppeteer",
      "typeVersion": 1,
      "position": [
        1488,
        48
      ],
      "id": "0667db85-6756-4efd-aa39-ab1bcbf85c8c",
      "name": "Truy c·∫≠p link l·∫•y th√¥ng tin",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9cb64851-9bfc-4b69-afdb-384b4d44bceb",
              "leftValue": "={{$json.skip}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "bc0d8486-b48d-4fb0-a2bf-c4f5ab15a225",
              "leftValue": "={{$json.skip}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1728,
        48
      ],
      "id": "ff8e7142-b334-4e25-b7b7-48ebd7318465",
      "name": "If"
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking ‚ÄòExecute workflow‚Äô": {
      "main": [
        [
          {
            "node": "L·∫•y ƒë·ªØ li·ªáu sheet list url c·∫ßn crawl",
            "type": "main",
            "index": 0
          },
          {
            "node": "X√≥a ƒë·ªØ li·ªáu c·ªßa sheet list link tuy·ªÉn d·ª•ng",
            "type": "main",
            "index": 0
          },
          {
            "node": "X√≥a danh s√°ch c√¥ng vi·ªác ƒë√£ crawl",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L·∫•y ƒë·ªØ li·ªáu sheet list url c·∫ßn crawl": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Truy c·∫≠p v√†o link l·∫•y ra c√¥ng vi·ªác": {
      "main": [
        [
          {
            "node": "Th√™m ƒë·ªØ li·ªáu v√†o sheet list link tuy·ªÉn d·ª•ng",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Th√™m ƒë·ªØ li·ªáu v√†o sheet list link tuy·ªÉn d·ª•ng": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Th√™m ƒë·ªØ li·ªáu v√†o sheet danh s√°ch c√¥ng vi·ªác ƒë√£ crawl": {
      "main": [
        [
          {
            "node": "L·∫∑p l·∫°i x·ª≠ l√Ω",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L·∫∑p l·∫°i x·ª≠ l√Ω": {
      "main": [
        [],
        [
          {
            "node": "Truy c·∫≠p link l·∫•y th√¥ng tin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "L·∫∑p l·∫°i x·ª≠ l√Ω",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Truy c·∫≠p v√†o link l·∫•y ra c√¥ng vi·ªác",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Truy c·∫≠p link l·∫•y th√¥ng tin": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "L·∫∑p l·∫°i x·ª≠ l√Ω",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Th√™m ƒë·ªØ li·ªáu v√†o sheet danh s√°ch c√¥ng vi·ªác ƒë√£ crawl",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "37572f5d-ac4c-45b5-b60d-c4b26dbdbcc1",
  "meta": {
    "instanceId": "be4bd479f567f96620153db3fcd673abbd059c76f34103f7251e61fb5e9ec621"
  },
  "id": "O7XXIuEyWPdMazGQ",
  "tags": []
}