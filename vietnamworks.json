{
  "name": "vietnamworks",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -240,
        272
      ],
      "id": "7e06c30e-1539-4968-b359-493630708474",
      "name": "When clicking ‚ÄòExecute workflow‚Äô"
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ",
          "mode": "list",
          "cachedResultName": "VietnamWork",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 690120639,
          "mode": "list",
          "cachedResultName": "JobDetail",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ/edit#gid=690120639"
        },
        "keepFirstRow": true
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        16,
        -80
      ],
      "id": "efdd06e4-a06d-4c44-8111-78887d081acc",
      "name": "X√≥a danh s√°ch c√¥ng vi·ªác ƒë√£ crawl",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ",
          "mode": "list",
          "cachedResultName": "VietnamWork",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 210296615,
          "mode": "list",
          "cachedResultName": "JobUrl",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ/edit#gid=210296615"
        },
        "keepFirstRow": true
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        16,
        80
      ],
      "id": "b78b5246-ddab-4e1d-bc4f-bbcb537ddaf9",
      "name": "X√≥a ƒë·ªØ li·ªáu c·ªßa sheet list url c·∫ßn crawl",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ",
          "mode": "list",
          "cachedResultName": "VietnamWork",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "SearchUrl",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ/edit#gid=0"
        },
        "combineFilters": "OR",
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        16,
        272
      ],
      "id": "a61e67ef-c719-4873-99eb-4404bac61af3",
      "name": "L·∫•y ƒë·ªØ li·ªáu sheet list url c·∫ßn crawl",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "runCustomScript",
        "scriptCode": "// --- Helper ---\nconst sleep = (ms) => new Promise((res) => setTimeout(res, ms));\n\n// --- L·∫§Y LINK ƒê·∫¶U V√ÄO ---\nlet baseUrl = $json.Url?.trim();\nif (!baseUrl) throw new Error(\"‚ùå Thi·∫øu 'Url' trong input!\");\n\nlet major = $json.Major || $json.major || \"\";\n\n// üü© GI·ªöI H·∫†N ƒê·ªÇ TR√ÅNH CRAWL QU√Å NHI·ªÄU\nconst MAX_PAGES = parseInt($json.MaxPages || $json.maxPages || \"5\"); // M·∫∑c ƒë·ªãnh 5 trang\nconst MAX_JOBS = parseInt($json.MaxJobs || $json.maxJobs || \"200\"); // M·∫∑c ƒë·ªãnh 200 job\n\nlet allJobs = [];\nlet currentPage = 1;\n\n// üü© T·ªëi ∆∞u: Ch·∫∑n request kh√¥ng c·∫ßn thi·∫øt ƒë·ªÉ tƒÉng t·ªëc\nawait $page.setRequestInterception(true);\n$page.on(\"request\", (req) => {\n  const t = req.resourceType();\n  const u = req.url();\n  if (\n    [\"image\", \"font\", \"media\"].includes(t) ||\n    /doubleclick|googletagmanager|analytics|facebook|adsystem|adservice|hotjar|mixpanel/i.test(u)\n  ) return req.abort();\n  req.continue();\n});\n\nwhile (true) {\n  // --- T·∫†O LINK PH√ÇN TRANG ---\n  let Url = baseUrl;\n  if (currentPage > 1) {\n    Url = baseUrl.includes(\"?\")\n      ? `${baseUrl}&page=${currentPage}`\n      : `${baseUrl}?page=${currentPage}`;\n  }\n\n  console.log(`üü¶ ƒêang x·ª≠ l√Ω trang ${currentPage}: ${Url}`);\n\n  // --- ƒêI ƒê·∫æN TRANG ---\n  await $page.goto(Url, { waitUntil: \"domcontentloaded\", timeout: 30000 });\n\n  // --- ƒê·ª¢I JOB HI·ªÜN RA ---\n  try {\n    await $page.waitForSelector(\".view_job_item h2 a, .search_list.view_job_item h2 a\", { timeout: 15000 });\n  } catch {\n    console.log(`‚ö†Ô∏è Kh√¥ng th·∫•y job ·ªü trang ${currentPage}, d·ª´ng l·∫°i.`);\n    break;\n  }\n\n  // --- CU·ªòN ƒê·ªÇ LOAD H·∫æT JOB (T·ªêI ∆ØU) ---\n  let lastCount = 0;\n  let noChangeCount = 0;\n  for (let i = 0; i < 10; i++) {\n    await $page.evaluate(() => window.scrollBy(0, document.body.scrollHeight));\n    await sleep(500);\n    const currentCount = await $page.$$eval(\n      \".view_job_item, .search_list.view_job_item\",\n      (els) => els.length\n    );\n    if (currentCount === lastCount) {\n      noChangeCount++;\n      if (noChangeCount >= 2) break;\n    } else {\n      noChangeCount = 0;\n    }\n    lastCount = currentCount;\n  }\n\n  // --- L·∫§Y D·ªÆ LI·ªÜU ---\n  const jobsOnPage = await $page.evaluate(() => {\n    const jobItems = document.querySelectorAll(\".view_job_item, .search_list.view_job_item\");\n    return Array.from(jobItems).map((item) => {\n      const titleEl = item.querySelector(\"h2 a[href]\");\n      const link = titleEl ? titleEl.href : \"\";\n      const title = titleEl ? titleEl.textContent.trim() : \"\";\n      return {\n        Url: link.startsWith(\"/\") ? \"https://www.vietnamworks.com\" + link : link,\n        title: title\n      };\n    });\n  });\n\n  console.log(`‚úÖ Trang ${currentPage} c√≥ ${jobsOnPage.length} job`);\n  if (jobsOnPage.length === 0) break;\n\n  // --- G·∫ÆN SOURCE + MAJOR ---\n  const mappedJobs = jobsOnPage.map((j) => ({\n    Source: baseUrl,\n    Url: j.Url,\n    link: j.Url,\n    title: j.title,\n    Major: major\n  }));\n\n  allJobs.push(...mappedJobs);\n\n  // üü© KI·ªÇM TRA GI·ªöI H·∫†N S·ªê L∆Ø·ª¢NG JOB\n  if (allJobs.length >= MAX_JOBS) {\n    console.log(`üõë ƒê√£ ƒë·∫°t gi·ªõi h·∫°n ${MAX_JOBS} job, d·ª´ng l·∫°i!`);\n    allJobs = allJobs.slice(0, MAX_JOBS); // C·∫Øt b·ªõt n·∫øu v∆∞·ª£t qu√°\n    break;\n  }\n\n  // üü© KI·ªÇM TRA GI·ªöI H·∫†N S·ªê TRANG\n  if (currentPage >= MAX_PAGES) {\n    console.log(`üõë ƒê√£ ƒë·∫°t gi·ªõi h·∫°n ${MAX_PAGES} trang, d·ª´ng l·∫°i!`);\n    break;\n  }\n\n  // --- KI·ªÇM TRA XEM C√íN TRANG KH√îNG ---\n  const nextExists = await $page.$(\"ul.pagination li.active + li button\");\n  if (!nextExists) {\n    console.log(\"üõë H·∫øt trang, d·ª´ng!\");\n    break;\n  }\n\n  currentPage++;\n  await sleep(800);\n}\n\nconsole.log(\"üéØ T·ªïng s·ªë vi·ªác l√†m:\", allJobs.length);\n\n// Tr·∫£ v·ªÅ d·∫°ng array cho n8n\nreturn allJobs.map(job => ({ json: job }));",
        "options": {
          "args": [
            "--no-sandbox",
            "--disable-setuid-sandbox",
            "--disable-dev-shm-usage",
            "--disable-accelerated-2d-canvas",
            "--no-first-run",
            "--no-zygote",
            "--disable-gpu"
          ]
        }
      },
      "type": "n8n-nodes-puppeteer.puppeteer",
      "typeVersion": 1,
      "position": [
        576,
        -128
      ],
      "id": "6b160cc0-5f51-4640-a30f-f645f4573d87",
      "name": "Truy c·∫≠p v√†o link l·∫•y ra c√¥ng vi·ªác",
      "alwaysOutputData": true,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ",
          "mode": "list",
          "cachedResultName": "VietnamWork",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 690120639,
          "mode": "list",
          "cachedResultName": "JobDetail",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ/edit#gid=690120639"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Ti√™u ƒë·ªÅ": "={{ $json[\"Ti√™u ƒë·ªÅ c√¥ng vi·ªác\"] }}",
            "Url": "={{ $json.Link }}",
            "L∆∞∆°ng": "={{ $json[\"L∆∞∆°ng\"] }}",
            "Tr√¨nh ƒë·ªô": "={{ $json[\"Tr√¨nh ƒë·ªô\"] }}",
            "S·ªë l∆∞·ª£ng": "={{ $json[\"S·ªë l∆∞·ª£ng\"] }}",
            "Kinh nghi·ªám": "={{ $json[\"Kinh nghi·ªám\"] }}",
            "Ng√†y ƒëƒÉng": "={{ $json[\"Ng√†y ƒëƒÉng\"] }}",
            "V·ªã tr√≠": "={{ $json[\"V·ªã tr√≠\"] }}",
            "H·∫°n tuy·ªÉn d·ª•ng": "={{ $json[\"H·∫°n tuy·ªÉn d·ª•ng\"] }}",
            "Chuy√™n ng√†nh": "={{ $json[\"Chuy√™n ng√†nh\"] }}",
            "C√¥ng ty": "={{ $json[\"T√™n c√¥ng ty\"] }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Ti√™u ƒë·ªÅ",
              "displayName": "Ti√™u ƒë·ªÅ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "C√¥ng ty",
              "displayName": "C√¥ng ty",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Url",
              "displayName": "Url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "L∆∞∆°ng",
              "displayName": "L∆∞∆°ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Tr√¨nh ƒë·ªô",
              "displayName": "Tr√¨nh ƒë·ªô",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "S·ªë l∆∞·ª£ng",
              "displayName": "S·ªë l∆∞·ª£ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Kinh nghi·ªám",
              "displayName": "Kinh nghi·ªám",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Ng√†y ƒëƒÉng",
              "displayName": "Ng√†y ƒëƒÉng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "V·ªã tr√≠",
              "displayName": "V·ªã tr√≠",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "H·∫°n tuy·ªÉn d·ª•ng",
              "displayName": "H·∫°n tuy·ªÉn d·ª•ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Chuy√™n ng√†nh",
              "displayName": "Chuy√™n ng√†nh",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2160,
        -32
      ],
      "id": "0d7b5e23-14aa-4f06-bf34-cb291a156afc",
      "name": "Th√™m ƒë·ªØ li·ªáu v√†o sheet danh s√°ch c√¥ng vi·ªác ƒë√£ crawl",
      "onError": "continueRegularOutput",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ",
          "mode": "list",
          "cachedResultName": "VietnamWork",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 210296615,
          "mode": "list",
          "cachedResultName": "JobUrl",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19FpVmUsyrf7Xjo-kFk4MjrXgRb3ibfumJNfwUz0yUBQ/edit#gid=210296615"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Url": "={{$json.link }}",
            "Source": "={{ $json.Url }}",
            "Major": "={{ $json.Major }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Source",
              "displayName": "Source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Url",
              "displayName": "Url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Major",
              "displayName": "Major",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "body",
              "displayName": "body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "headers",
              "displayName": "headers",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "statusCode",
              "displayName": "statusCode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1072,
        368
      ],
      "id": "f468a0cc-095b-435d-bb7d-290e400156e1",
      "name": "Th√™m ƒë·ªØ li·ªáu v√†o sheet list link tuy·ªÉn d·ª•ng",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "KWvXTlQdV9eqObfN",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1920,
        256
      ],
      "id": "e4f1665d-4087-4b1f-97d2-875236dfe6b1",
      "name": "L·∫∑p l·∫°i x·ª≠ l√Ω",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        288,
        272
      ],
      "id": "e53784dd-a8a4-4936-a86f-5099173c46b6",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "operation": "runCustomScript",
        "scriptCode": "// üü© B·ªçc to√†n b·ªô trong try-catch ƒë·ªÉ b·ªè qua link l·ªói\ntry {\n// üü© L·∫•y bi·∫øn t·ª´ input JSON\nconst { Url: inputUrl, Major } = $json;\n\n// üü© Chu·∫©n h√≥a URL\nlet jobUrl = (inputUrl || \"\").trim();\nif (!jobUrl) {\n  console.log(\"‚ö†Ô∏è B·ªè qua: Kh√¥ng c√≥ URL h·ª£p l·ªá\");\n  return [   {     json: {       skip: true,       Link: jobUrl || \"\",       message: \"URL l·ªói, b·ªè qua\"     }   } ];\n}\nif (jobUrl.startsWith(\"/\")) jobUrl = \"https://www.vietnamworks.com\" + jobUrl;\n\n// üü© Th√™m User-Agent ƒë·ªÉ tr√°nh b·ªã ch·∫∑n\nawait $page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');\n\n// üü© Th√™m extra headers\nawait $page.setExtraHTTPHeaders({\n  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',\n  'Accept-Language': 'vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7',\n  'Accept-Encoding': 'gzip, deflate, br',\n  'Connection': 'keep-alive',\n  'Upgrade-Insecure-Requests': '1'\n});\n\n// üü© Gi·∫£m t·∫£i request r√°c (T·ªêI ∆ØU)\nawait $page.setRequestInterception(true);\n$page.on(\"request\", (req) => {\n  const t = req.resourceType();\n  const u = req.url();\n  if (\n    [\"image\", \"font\", \"media\"].includes(t) ||\n    /doubleclick|googletagmanager|analytics|facebook|adsystem|adservice|hotjar|mixpanel/i.test(u)\n  ) return req.abort();\n  req.continue();\n});\n\n// üü© Delay tr∆∞·ªõc khi truy c·∫≠p ƒë·ªÉ tr√°nh b·ªã ch·∫∑n\nawait new Promise(r => setTimeout(r, 1000 + Math.random() * 2000));\n\n// üü© Retry logic v·ªõi exponential backoff\nlet retries = 3;\nlet lastError = null;\nwhile (retries > 0) {\n  try {\n    // üü© Truy c·∫≠p trang v·ªõi timeout tƒÉng l√™n\n    await $page.goto(jobUrl, { \n      waitUntil: \"networkidle2\", \n      timeout: 60000 \n    });\n    break; // Th√†nh c√¥ng, tho√°t kh·ªèi retry loop\n  } catch (error) {\n    lastError = error;\n    retries--;\n    if (retries > 0) {\n      const delay = Math.pow(2, 3 - retries) * 2000; // 2s, 4s, 8s\n      console.log(`‚ö†Ô∏è L·ªói khi truy c·∫≠p ${jobUrl}, retry sau ${delay}ms... (c√≤n ${retries} l·∫ßn)`);\n      await new Promise(r => setTimeout(r, delay));\n    } else {\n      console.log(`‚ùå Kh√¥ng th·ªÉ truy c·∫≠p ${jobUrl} sau 3 l·∫ßn th·ª≠`);\n      // Th·ª≠ v·ªõi domcontentloaded n·∫øu networkidle2 fail\n      try {\n        await $page.goto(jobUrl, { waitUntil: \"domcontentloaded\", timeout: 30000 });\n      } catch (e) {\n        console.log(`‚ùå B·ªè qua link ${jobUrl} do l·ªói: ${lastError.message}`);\n        return [   {     json: {       skip: true,       Link: jobUrl || \"\",       message: \"URL l·ªói, b·ªè qua\"     }   } ]; // B·ªè qua link n√†y, ti·∫øp t·ª•c v·ªõi link kh√°c\n      }\n    }\n  }\n}\n\n// üü© Ch·ªù trang load ho√†n to√†n\nawait new Promise(r => setTimeout(r, 2000));\n\n// üü© Ch·ªù ti√™u ƒë·ªÅ xu·∫•t hi·ªán - tƒÉng timeout\ntry {\n  await $page.waitForSelector(\"h1[name='title']\", { timeout: 30000 });\n} catch (e) {\n  console.log(\"‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ti√™u ƒë·ªÅ, ti·∫øp t·ª•c...\");\n  // Ki·ªÉm tra xem c√≥ b·ªã redirect ho·∫∑c block kh√¥ng\n  const currentUrl = $page.url();\n  if (currentUrl.includes('blocked') || currentUrl.includes('error') || currentUrl !== jobUrl) {\n    console.log(`‚ö†Ô∏è URL b·ªã thay ƒë·ªïi: ${currentUrl} (g·ªëc: ${jobUrl})`);\n  }\n}\n\n// üü© M·ªü r·ªông c√°c ph·∫ßn Xem th√™m (T·ªêI ∆ØU: gi·∫£m s·ªë l·∫ßn l·∫∑p v√† sleep)\nfor (let i = 0; i < 5; i++) { // Gi·∫£m t·ª´ 8 xu·ªëng 5\n  const clicked = await $page.evaluate(() => {\n    let c = 0;\n    document.querySelectorAll('button[aria-label=\"Xem th√™m\"]').forEach(btn => {\n      if (btn.offsetParent) { btn.click(); c++; }\n    });\n    return c;\n  });\n  if (!clicked) break;\n  await new Promise(r => setTimeout(r, 300)); // Gi·∫£m t·ª´ 500ms xu·ªëng 300ms\n}\n\n// üü© Cu·ªôn ƒë·ªÉ t·∫£i h·∫øt n·ªôi dung (T·ªêI ∆ØU: scroll nhanh h∆°n, √≠t sleep)\nawait $page.evaluate(async () => {\n  await new Promise(res => {\n    let y = 0;\n    const step = 1000; // TƒÉng step l√™n 1000px ƒë·ªÉ scroll nhanh h∆°n\n    const t = setInterval(() => {\n      window.scrollBy(0, step);\n      y += step;\n      if (y > document.body.scrollHeight + 1200) {\n        clearInterval(t);\n        res();\n      }\n    }, 80); // Gi·∫£m interval t·ª´ 100ms xu·ªëng 80ms\n  });\n});\nawait new Promise(r => setTimeout(r, 300)); // Gi·∫£m t·ª´ 500ms xu·ªëng 300ms\n\n// üü© Thu th·∫≠p d·ªØ li·ªáu ch√≠nh\nconst job = await $page.evaluate((Major) => {\n  const get = (sel) => document.querySelector(sel)?.textContent.trim() || null;\n\n  // === L·∫•y th√¥ng tin ch√≠nh ===\n  const title = get(\"h1[name='title']\") || \"Kh√¥ng x√°c ƒë·ªãnh\";\n  const company = get(\"a[name='label']\") || \"Kh√¥ng x√°c ƒë·ªãnh\";\n\n  // --- L∆∞∆°ng & H·∫°n (S·ª¨A: ch·ªâ l·∫•y ph·∫ßn l∆∞∆°ng, c·∫Øt b·ªè ph·∫ßn m√¥ t·∫£, chuy·ªÉn USD sang VNƒê) ---\n  let salaryRaw = get('div[id=\"vnwLayout__col\"] span[name=\"label\"]') || \"Th·ªèa thu·∫≠n\";\n  // C·∫Øt b·ªè ph·∫ßn m√¥ t·∫£ ph√≠a sau (n·∫øu c√≥)\n  let salary = salaryRaw.split(/M·ª©c l∆∞∆°ng ph·ªï bi·∫øn|m·ª©c l∆∞∆°ng ph·ªï bi·∫øn|Th√¥ng tin th√™m|th√¥ng tin th√™m/i)[0].trim() || \"Th·ªèa thu·∫≠n\";\n  \n  // üü© Format l∆∞∆°ng: \"th∆∞∆°ng l∆∞·ª£ng\" => ƒë·ªÉ tr·ªëng\n  if (salary && salary.toLowerCase().includes(\"th∆∞∆°ng l∆∞·ª£ng\")) {\n    salary = \"\";\n  }\n  \n  // üü© Chuy·ªÉn ƒë·ªïi USD sang VNƒê v√† format theo Xtr-Ytr VNƒê/th√°ng\n  const USD_TO_VND = 24500; // T·ª∑ gi√° m·∫∑c ƒë·ªãnh\n  if (salary && (salary.includes(\"$\") || salary.includes(\"USD\") || salary.includes(\"dollar\"))) {\n    // T√¨m t·∫•t c·∫£ s·ªë ti·ªÅn USD (h·ªó tr·ª£ kho·∫£ng l∆∞∆°ng nh∆∞ $1,000 - $2,000)\n    const usdMatches = Array.from(salary.matchAll(/\\$?([\\d,]+(?:\\.[\\d]+)?)/g));\n    \n    if (usdMatches.length > 0) {\n      const amounts = usdMatches.map(match => {\n        const usdAmount = parseFloat(match[1].replace(/,/g, \"\"));\n        const vndAmount = Math.round(usdAmount * USD_TO_VND);\n        // Chuy·ªÉn sang ƒë∆°n v·ªã tr (tri·ªáu ƒë·ªìng)\n        const trieu = (vndAmount / 1000000).toFixed(1);\n        // B·ªè s·ªë 0 th·ª´a (10.0 -> 10)\n        return parseFloat(trieu).toString().replace(/\\.0$/, \"\") + \"tr\";\n      });\n      \n      // Format theo Xtr-Ytr VNƒê/th√°ng ho·∫∑c Xtr VNƒê/th√°ng\n      if (amounts.length === 1) {\n        salary = amounts[0] + \" VNƒê/th√°ng\";\n      } else if (amounts.length === 2) {\n        salary = amounts[0] + \"-\" + amounts[1] + \" VNƒê/th√°ng\";\n      } else {\n        // N·∫øu c√≥ nhi·ªÅu h∆°n 2 s·ªë, l·∫•y min v√† max\n        const nums = amounts.map(a => parseFloat(a.replace(/tr/, \"\")));\n        const min = Math.min(...nums);\n        const max = Math.max(...nums);\n        salary = min + \"tr-\" + max + \"tr VNƒê/th√°ng\";\n      }\n    }\n  }\n  const deadline =\n    get('span[name=\"paragraph\"][color=\"#000\"]') || \"Kh√¥ng x√°c ƒë·ªãnh\";\n\n  // --- C√°c m·ª•c th√¥ng tin ---\n  let position = \"Kh√¥ng x√°c ƒë·ªãnh\",\n      education = \"Kh√¥ng x√°c ƒë·ªãnh\",\n      experience = \"Kh√¥ng x√°c ƒë·ªãnh\",\n      quantity = \"Kh√¥ng x√°c ƒë·ªãnh\",\n      postedDate = new Date().toISOString().split(\"T\")[0];\n\n  document.querySelectorAll(\"div.JtIju\").forEach((block) => {\n    const label = block.querySelector(\"label.dfyRSX\")?.innerText.toLowerCase() || \"\";\n    const val = block.querySelector(\"p.cLLblL, span.bPjxRh, li, a\")?.innerText.trim() || \"\";\n\n    if (label.includes(\"h·ªçc v·∫•n\") || label.includes(\"tr√¨nh ƒë·ªô\")) education = val;\n    if (label.includes(\"c·∫•p b·∫≠c\")) position = val;\n    if (label.includes(\"kinh nghi·ªám\")) experience = val;\n    if (label.includes(\"s·ªë l∆∞·ª£ng\")) quantity = val;\n    if (label.includes(\"ƒëƒÉng\") || label.includes(\"ng√†y t·∫°o\")) postedDate = val || postedDate;\n  });\n\n  // üü© Format tr√¨nh ƒë·ªô: \"Kh√¥ng gi·ªõi h·∫°n\" => ƒë·ªÉ tr·ªëng\n  if (education && education.toLowerCase().includes(\"kh√¥ng gi·ªõi h·∫°n\")) {\n    education = \"\";\n  }\n\n  // üü© Format s·ªë l∆∞·ª£ng: \"Kh√¥ng x√°c ƒë·ªãnh\", \"Kh√¥ng hi·ªÉn th·ªã\" => \"1\"\n  if (quantity && (quantity.toLowerCase().includes(\"kh√¥ng x√°c ƒë·ªãnh\") || quantity.toLowerCase().includes(\"kh√¥ng hi·ªÉn th·ªã\"))) {\n    quantity = \"1\";\n  }\n\n  return {\n    title, company, salary, education, position,\n    experience, quantity, postedDate, deadline,\n    major: Major, link: window.location.href\n  };\n}, Major);\n\n// üü© Tr·∫£ k·∫øt qu·∫£\nreturn [\n  {\n    json: {\n      \"Ti√™u ƒë·ªÅ c√¥ng vi·ªác\": job.title,\n      \"T√™n c√¥ng ty\": job.company,\n      \"Link\": job.link,\n      \"L∆∞∆°ng\": job.salary,\n      \"Tr√¨nh ƒë·ªô\": job.education,\n      \"V·ªã tr√≠\": job.position,\n      \"Kinh nghi·ªám\": job.experience,\n      \"S·ªë l∆∞·ª£ng\": job.quantity,\n      \"Ng√†y ƒëƒÉng\": job.postedDate,\n      \"H·∫°n tuy·ªÉn d·ª•ng\": job.deadline,\n      \"Chuy√™n ng√†nh\": job.major,\n    },\n  },\n];\n\n} catch (error) {\n  // üü© B·ªè qua link l·ªói, log v√† ti·∫øp t·ª•c v·ªõi link kh√°c\n  console.log(`‚ùå L·ªói khi x·ª≠ l√Ω link ${$json.Url || $json.inputUrl || 'unknown'}: ${error.message}`);\n  return [   {     json: {       skip: true,       Link: jobUrl || "",       message: "URL l·ªói, b·ªè qua"     }   } ]; // Tr·∫£ v·ªÅ skip ƒë·ªÉ b·ªè qua link n√†y\n}",
        "options": {
          "args": [
            "--no-sandbox",
            "--disable-setuid-sandbox",
            "--disable-dev-shm-usage",
            "--disable-accelerated-2d-canvas",
            "--no-first-run",
            "--no-zygote",
            "--disable-gpu"
          ]
        }
      },
      "type": "n8n-nodes-puppeteer.puppeteer",
      "typeVersion": 1,
      "position": [
        1488,
        -32
      ],
      "id": "68632c41-9c98-495d-a07a-38643ff91c73",
      "name": "Puppeteer",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9cb64851-9bfc-4b69-afdb-384b4d44bceb",
              "leftValue": "={{$json.skip}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "bc0d8486-b48d-4fb0-a2bf-c4f5ab15a225",
              "leftValue": "={{$json.skip}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1728,
        -32
      ],
      "id": "ff8e7142-b334-4e25-b7b7-48ebd7318465",
      "name": "If"
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking ‚ÄòExecute workflow‚Äô": {
      "main": [
        [
          {
            "node": "L·∫•y ƒë·ªØ li·ªáu sheet list url c·∫ßn crawl",
            "type": "main",
            "index": 0
          },
          {
            "node": "X√≥a ƒë·ªØ li·ªáu c·ªßa sheet list url c·∫ßn crawl",
            "type": "main",
            "index": 0
          },
          {
            "node": "X√≥a danh s√°ch c√¥ng vi·ªác ƒë√£ crawl",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L·∫•y ƒë·ªØ li·ªáu sheet list url c·∫ßn crawl": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Truy c·∫≠p v√†o link l·∫•y ra c√¥ng vi·ªác": {
      "main": [
        [
          {
            "node": "Th√™m ƒë·ªØ li·ªáu v√†o sheet list link tuy·ªÉn d·ª•ng",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Th√™m ƒë·ªØ li·ªáu v√†o sheet list link tuy·ªÉn d·ª•ng": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Th√™m ƒë·ªØ li·ªáu v√†o sheet danh s√°ch c√¥ng vi·ªác ƒë√£ crawl": {
      "main": [
        [
          {
            "node": "L·∫∑p l·∫°i x·ª≠ l√Ω",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L·∫∑p l·∫°i x·ª≠ l√Ω": {
      "main": [
        [],
        [
          {
            "node": "Puppeteer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "L·∫∑p l·∫°i x·ª≠ l√Ω",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Truy c·∫≠p v√†o link l·∫•y ra c√¥ng vi·ªác",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Puppeteer": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "L·∫∑p l·∫°i x·ª≠ l√Ω",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Th√™m ƒë·ªØ li·ªáu v√†o sheet danh s√°ch c√¥ng vi·ªác ƒë√£ crawl",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "cf2bd192-29ec-4852-9761-f47e08793fef",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "be4bd479f567f96620153db3fcd673abbd059c76f34103f7251e61fb5e9ec621"
  },
  "id": "QNZIXG49gtXSI6sB",
  "tags": []
}